# Scheduled Platform Automation
#
# Copyright (c) 2025 Poor Dude Holdings LLC. All Rights Reserved.
# PROPRIETARY AND CONFIDENTIAL - Unauthorized use prohibited.

name: Scheduled Platform Automation

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      log_level:
        description: 'Log level'
        required: false
        default: 'INFO'
        type: choice
        options:
          - DEBUG
          - INFO
          - WARNING
          - ERROR

jobs:
  run-automation:
    name: Run Platform Automation Script
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          cd backend && pip install -r requirements.txt
          pip install pyyaml requests
      
      - name: Setup environment variables
        env:
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
          DATABASE_URL: ${{ secrets.DATABASE_URL_PRODUCTION }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          MONETIZATION_API_KEY: ${{ secrets.MONETIZATION_API_KEY }}
        run: |
          echo "Environment configured"
      
      - name: Run automation pipeline
        env:
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
          DATABASE_URL: ${{ secrets.DATABASE_URL_PRODUCTION }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          MONETIZATION_API_KEY: ${{ secrets.MONETIZATION_API_KEY }}
          LOG_LEVEL: ${{ github.event.inputs.log_level || 'INFO' }}
        run: |
          python tools/automated_platform.py
      
      - name: Upload automation reports
        uses: actions/upload-artifact@v4.1.3
        if: always()
        with:
          name: automation-reports-${{ github.run_number }}
          path: |
            data/automated/reports/
            data/automated/logs/
          retention-days: 90
      
      - name: Notify on failure
        if: failure()
        run: |
          echo "Automation pipeline failed!"
          echo "Run ID: ${{ github.run_id }}"
          echo "Run Number: ${{ github.run_number }}"
          # Add notification logic here (e.g., Slack webhook, email, etc.)
          # Example:
          # curl -X POST -H 'Content-type: application/json' \
          #   --data '{"text":"Platform automation failed! Run: ${{ github.run_id }}"}' \
          #   ${{ secrets.SLACK_WEBHOOK_URL }}
