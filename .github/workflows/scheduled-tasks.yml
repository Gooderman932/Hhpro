name: Scheduled Automation Tasks

on:
  schedule:
    # Daily tasks at 2 AM UTC
    - cron: '0 2 * * *'
    # Weekly tasks on Sundays at 3 AM UTC
    - cron: '0 3 * * 0'
  workflow_dispatch:
    inputs:
      task_type:
        description: 'Type of task to run'
        required: true
        type: choice
        options:
          - daily
          - weekly
        default: 'daily'

jobs:
  daily-automation:
    name: Daily Platform Automation
    runs-on: ubuntu-latest
    if: (github.event.schedule == '0 2 * * *') || (github.event_name == 'workflow_dispatch' && github.event.inputs.task_type == 'daily')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt
      
      - name: Run automated platform manager
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_PRODUCTION }}
          SECRET_KEY: ${{ secrets.SECRET_KEY_PRODUCTION }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          MONETIZATION_API_KEY: ${{ secrets.MONETIZATION_API_KEY }}
        run: |
          python tools/automated_platform.py
      
      - name: Generate health reports
        run: |
          echo "Generating daily health reports..."
          mkdir -p reports
          # The automated_platform.py script generates reports
          ls -la data/automated/reports/ || echo "No reports directory yet"
      
      - name: Archive reports
        uses: actions/upload-artifact@v4
        with:
          name: daily-reports-${{ github.run_number }}
          path: data/automated/reports/
          retention-days: 30
        continue-on-error: true
      
      - name: Send summary notification
        if: always()
        run: |
          STATUS="${{ job.status }}"
          echo "Daily automation completed with status: $STATUS"
          # Add webhook notification here
          # curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
          #   -H 'Content-Type: application/json' \
          #   -d '{"text":"Daily automation '"$STATUS"' - Reports generated"}'

  weekly-maintenance:
    name: Weekly Platform Maintenance
    runs-on: ubuntu-latest
    if: (github.event.schedule == '0 3 * * 0') || (github.event_name == 'workflow_dispatch' && github.event.inputs.task_type == 'weekly')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt
      
      - name: Comprehensive health audit
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_PRODUCTION }}
        run: |
          echo "Running comprehensive health audit..."
          # Add your health audit script here
      
      - name: Database optimization
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_PRODUCTION }}
        run: |
          echo "Running database optimization..."
          # Add VACUUM, ANALYZE, index optimization, etc.
      
      - name: Cleanup old data and logs
        run: |
          echo "Cleaning up old data..."
          # Add cleanup logic for logs older than 30 days
          find data/automated/logs -type f -mtime +30 -delete || true
          find data/automated/reports -type f -mtime +90 -delete || true
      
      - name: Generate weekly business reports
        run: |
          echo "Generating weekly business reports..."
          # Run the platform manager with weekly flag
          python tools/automated_platform.py
      
      - name: Archive weekly reports
        uses: actions/upload-artifact@v4
        with:
          name: weekly-reports-${{ github.run_number }}
          path: data/automated/reports/
          retention-days: 90
        continue-on-error: true
      
      - name: Send weekly summary
        if: always()
        run: |
          STATUS="${{ job.status }}"
          echo "Weekly maintenance completed with status: $STATUS"
          # Add webhook notification
